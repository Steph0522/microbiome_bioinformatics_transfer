---
bibliography: references.bib
---



# `r fontawesome::fa("book", fill=" #722F37")` : Asignación taxonómica

## Base de datos Greengenes2 

::: {.alert .alert-info role="alert"}
<i class="bi-clipboard-fill"></i> En la siguiente parte se descarga la base de datos de greengenes2 y se depura manualmente en R. Esta parte no la vamos a correr, solo dejamos el script para que lo intentes con más tiempo y disponibilidad.
:::


```{r, eval=FALSE}
#https://github.com/benjjneb/dada2/issues/1680#issuecomment-1724495374

download.file("http://ftp.microbio.me/greengenes_release/current/2024.09.backbone.full-length.fna.qza", "2024.09.backbone.full-length.fna.qza")
download.file("http://ftp.microbio.me/greengenes_release/current/2024.09.backbone.tax.qza",
              "2024.09.backbone.tax.qza")

unzip("2024.09.backbone.full-length.fna.qza")
unzip("2024.09.backbone.tax.qza")


fn <- "5b42d9b6-2f24-4f01-b989-9b4dafca7d5e/data/dna-sequences.fasta"
txfn <- "b7c3e691-ea51-4547-94dd-f79f49e41a36//data/taxonomy.tsv"

sq <- getSequences(fn)
tdf <- read.csv(txfn, sep="\t", header=TRUE)
tdf2 <- tdf[match(names(sq), tdf$Feature.ID),]
tax <- tdf2[,2]
names(tax) <- tdf2[,1]

identical(names(sq), names(tax)) # TRUE

taxes <- strsplit(tax, "; ")
tax.depth <- sapply(taxes, length)
table(tax.depth) 
# Todas las taxonomias son de 7 niveles
# Nota: Las especies tienen generos con nombres duplicados en vez de especies

# Remover el género de las especies
for(i in seq(length(taxes))) {
  gen <- taxes[[i]][[6]]
  gen <- substr(gen, 4, nchar(gen))
  taxes[[i]][[7]] <- gsub(gen, "", taxes[[i]][[7]])
  taxes[[i]][[7]] <- gsub("__ ", "__", taxes[[i]][[7]])
}

tax_pre <- c("d__", "p__", "c__", "o__", "f__", "g__", "s__")
is.unassigned <- sapply(taxes, function(tx) {
  tx == tax_pre
}) |> t()
tax.depth <- apply(is.unassigned, 1, function(isu) { min(which(isu)-1L, 7L) })
tax.ids <- sapply(seq_along(taxes), function(i) {
  td <- tax.depth[[i]]
  id.str <- paste(taxes[[i]][1:td], collapse=";")
  id.str <- paste0(id.str, ";") # Add terminal semicolon
  id.str
})
names(tax.ids) <- names(taxes)
# Write out the training fasta file
sq.out <- sq
names(sq.out) <- tax.ids
writeFasta(sq.out, "greengenes2_trainset.fa.gz", compress=TRUE)
# Sanity test the results of `assignTaxonomy` on this newly created training
dada2:::tax.check("greengenes2_trainset.fa.gz", fn.test=system.file("extdata", "ten_16s.100.fa.gz", package="dada2"))
```


Te dejamos mejor la liga para que descargues la base de datos de referencia ya depurada en su última versión, [Liga](https://drive.google.com/file/d/11NzusIlBFoX5zXBiG7Y8WJbqGYEdYyoo/view?usp=drive_link)

La descargamos y la ponemos en nuestro directorio de trabajo.


## Asignación taxonómica

```{r, eval=FALSE}
#duración : aprox 7 min

classifier <- "greengenes2_trainset.fa.gz" 
taxa <- assignTaxonomy(seqtab_nochim, classifier, multithread = TRUE, tryRC = TRUE)

# Visualizar lo que se genero despues de la asignacion
taxa_print <- taxa
rownames(taxa_print) <- NULL

head(taxa_print)
dim(taxa_print)
```


```{r, echo=FALSE}
#write.csv(taxa, "taxa.csv")
taxa_print = read.csv("taxa_print.csv", check.names = F)
head(taxa_print)
dim(taxa_print)
```


```{r, eval=FALSE}
# Exportar objetos generados durante el preprocesamiento 
save( errF, dadaFs, dadaRs,seqtab_nochim, taxa,
      file = "data.RData")
write.csv(taxa, "taxonomy.csv")
write.csv(seqtab_nochim, "table.csv")
write.csv(stats, "stats.csv")

```

