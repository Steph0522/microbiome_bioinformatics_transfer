

# `r fontawesome::fa("book", fill=" #722F37")` : Análisis exploratorio

## Phyloseq

- Primero vamos  a cargar las librerías a usar

```{r, echo=FALSE}
taxa = read.csv("taxa.csv", row.names = 1)
taxa <- as.matrix(taxa)
mode(taxa) <- "character"
```


```{r}
library(phyloseq)
library(Biostrings)
library(tidyverse)
theme_set(theme_bw())
```

- Cargamos la metadata y ordenamos

```{r}
samples.out <- rownames(seqtab_nochim)
samdf <-read.delim("Datos/seqs_transfer/sra-metadata.tsv") %>% 
  dplyr::rename(Origen="Host.Life.Stage..sample.", Tipo="Host.Tissue.Sampled..sample.")
seqtab.nochim <- seqtab_nochim[match(samdf$ID, rownames(seqtab_nochim)),]
rownames(samdf) <- samdf$ID
```


- Construimos un objeto phyloseq

```{r}
ps <- phyloseq(otu_table(seqtab.nochim, taxa_are_rows=FALSE), 
               sample_data(samdf), 
               tax_table(taxa))
ps
```

- Renombramos los ids de las secuencias y agregamos el rep_seqs

```{r}
dna <- Biostrings::DNAStringSet(taxa_names(ps))
names(dna) <- taxa_names(ps)
ps <- merge_phyloseq(ps, dna)
taxa_names(ps) <- paste0("ASV", seq(ntaxa(ps)))
ps

```

### Composición taxonómica

```{r}
ps.prop <- transform_sample_counts(ps, function(OTU) OTU/sum(OTU))
```


#### Phylum

```{r}
my_phyla <- tax_glom(ps.prop ,taxrank = "Phylum")
my_bar_phyla <- plot_bar(my_phyla, fill="Phylum") + 
facet_grid(~Origen+Tipo, scales="free_x")+
  ggtitle("Abundancia relativa de Filos") 
my_bar_phyla
```

#### Class

```{r}
my_Class <- tax_glom(ps.prop ,taxrank = "Class")
my_bar_Class <- plot_bar(my_Class, fill="Class") + 
facet_grid(~Origen+Tipo, scales="free_x")+
  ggtitle("Abundancia relativa de clases") 
my_bar_Class
```

### Diversidad alfa

- Primero hacemos subconjuntos del origen

```{r}

#madre
madre <- subset_samples(ps, Origen=="adult")
madre

#embrion
embrion <- subset_samples(ps, Origen=="embryo")
embrion

```
- Graficamos la diversidad alfa

```{r}
plot_richness(madre, x="Tipo", measures=c("Observed","Shannon", "Simpson"), color="Tipo")

```
```{r}
plot_richness(madre, x="Tipo", measures=c("Observed","Shannon", "Simpson"), color="Tipo")+
  geom_boxplot()
```

```{r}
plot_richness(embrion, x="Tipo", measures=c("Observed","Shannon", "Simpson"), color="Tipo")+
  geom_boxplot()

```
- rarificar si es necesario

```{r}
#ps_rare <- rarefy_even_depth(ps_fil, sample.size = min(sample_sums(ps_fil)), rngseed = 19)
#ps_rare
```


### Diversidad beta

```{r}
# Transformar la data  proporciones
ps.prop <- transform_sample_counts(ps, function(otu) otu/sum(otu))
ord.nmds.bray <- ordinate(ps.prop, method="NMDS", distance="bray")
plot_ordination(ps.prop, ord.nmds.bray, color="Tipo", shape="Origen",title="Bray NMDS")
```

```{r}
ord.nmds.jac <- ordinate(ps.prop, method="PCoA", distance="jaccard")
plot_ordination(ps, ord.nmds.jac, color="Tipo", shape="Origen",title="Bray NMDS")
```

## MicroBioMeta

[MicroBioMeta](https://github.com/Steph0522/MicroBioMeta): Paquete en desarrollo para la exploración de datos de microbioma y metagenómicos.

```{r, eval=FALSE}
install.packages("devtools")
library(devtools)
install_github("Steph0522/MicroBioMeta")
library(MicroBioMeta)
```

### Pre-procesamiento

```{r}
taxonomys <- taxa %>%
  as.data.frame() %>%
  tidyr::unite("taxonomy", Kingdom:Species, sep = ";")
```


```{r}
tabla = merge_feature_taxonomy(t(seqtab.nochim), taxonomys)
```


### Composición
```{r,warning=FALSE}
abundance_barplot(
  table = tabla,
  metadata = samdf %>% dplyr::rename("SAMPLEID"="ID"),
  level = "phylum",
  top_n_groups = 10,
  x_col = "Tipo",
  facet_col = "Origen"
)+theme(axis.text.x = element_text(angle = 50, hjust = 0.95))
```

```{r, warning=FALSE}
abundance_barplot(
  table = tabla,
  metadata = samdf %>% dplyr::rename("SAMPLEID"="ID"),
  level = "genus",
  top_n_groups = 20,
  x_col = "Tipo",
  facet_col = "Origen",add_remained = TRUE,
)+theme(axis.text.x = element_text(angle = 50, hjust = 0.95))
```


```{r, warning=FALSE}
abundance_heatmap_plot(
  table = tabla,
  metadata = samdf,
  condition1 = "Origen",
  condition2 = "Tipo",
  top_n = 20,
  cluster = TRUE,
  show_column_names = FALSE
)
```


### Diversidad alpha


```{r, warning=FALSE}
alpha_hill_plot(
  table = tabla,
  metadata = samdf,
  x_col = "Tipo",
  fill_col = "Tipo",
  stat = "anova"
) + theme(axis.text.x = element_blank(),
          axis.ticks.x = element_blank())

```

### Diversidad beta

```{r, warning=FALSE}
beta_div_plot(
  table = tabla,
  metadata = samdf,
  group_col = "Tipo",
  shape_col = "Origen",
  ordination = "PCoA",
  distance = "aitchison"
)
```




